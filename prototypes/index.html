<style>
  body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #f0f0f0;
  }
</style>

<script src="https://unpkg.com/konva@8.3.0/konva.min.js"></script>

<body>
    <div id="canvas-container"></div>
    <script>
      /*
        TODO:
        vison
      */

      const width = window.innerWidth
      const height = window.innerHeight

      const stage = new Konva.Stage({
        container: 'canvas-container',
        width: width,
        height: height,
      })

      console.log(stage)

      const obstacles = []

      const layer = new Konva.Layer()

      const coreLayer = new Konva.Layer()

      stage.add(coreLayer)

      const core = new Konva.RegularPolygon({
        x: 1800,
        y: 500,
        sides: 6,
        radius: 40,
        fill: 'green',
        stroke: 'black',
        strokeWidth: 4,
      })

      coreLayer.add(core)
      obstacles.push(coreLayer)

      const start = new Konva.Text({
        x: stage.width() / 2,
        y: 15,
        text: 'Start',
        fontSize: 30,
        fontFamily: 'Calibri',
        fill: 'green',
      })

      layer.add(start)
  
      const line = new Konva.Line({
        points: [0, 1100, width, 1100],
        stroke: 'black',
        strokeWidth: 3,
      })

      layer.add(line)
      stage.add(layer)


      const wall = new Konva.Rect({
        x: 1500,
        y: 1130,
        width: 20,
        height: 100,
        fill: 'green',
        stroke: 'black',
        strokeWidth: 1,
        draggable: true
      })

      const wallLayer = new Konva.Layer()

      wall.on('mouseout', _ => {
        const wall = new Konva.Rect({
          x: 1500,
          y: 1130,
          width: 20,
          height: 100,
          fill: 'green',
          stroke: 'black',
          strokeWidth: 1,
          draggable: true
        })
        wallLayer.add(wall)
      })

      wallLayer.add(wall)
      stage.add(wallLayer)

      obstacles.push(wallLayer)

      start.on('click', _ => {
        runGame()
      })

      function runGame() {
        function createCircles(n) {
          const circles = []
          
          for (let i = 0; i < n; i++) {
            let circle = new Konva.Circle({
              x: 20,
              y: 500,
              radius: 10,
              fill: 'blue', // TODO
              strokeWidth: 0,
            })

            layer.add(circle)
            stage.add(layer)

            circles.push({ i, o: circle })
          }

          return circles
        }

        const circles = createCircles(8)

        const moves = [ // Testing
          { i: 0, direction: 'down' },
          { i: 1, direction: 'up' },
          { i: 2, direction: 'left' },
          { i: 3, direction: 'right' },
          { i: 4, direction: 'downleft' },
          { i: 5, direction: 'downright' },
          { i: 6, direction: 'upleft' },
          { i: 7, direction: 'upright' },
        ]

        function move(circles, moves) {
          for (const move of moves) {
            const step = 3

            const c = circles.find(x => x.i === move.i)
          
            let newX = c.o.attrs.x
            let newY = c.o.attrs.y

            if (move.direction === 'down') {
              newY = newY + step
            } else if (move.direction === 'downright') {
              newX = newX + step
              newY = newY + step
            } else if (move.direction === 'up') {
              newY = newY - step
            } else if (move.direction === 'downleft') {
              newX = newX - step
              newY = newY + step
            } else if (move.direction === 'right') {
              newX = newX + step
            } else if (move.direction === 'left') {
              newX = newX - step
            } else if (move.direction === 'upright') {
              newX = newX + step
              newY = newY - step
            } else if (move.direction === 'upleft') {
              newX = newX - step
              newY = newY - step
            }

            const collision = (x, y) => {
              let result = { collision: 0, reverse: 0 }
              // edges
              if (x <= 0 || y <= 0 || y >= 1100 || x >= window.innerWidth) result.collision = 1

              // walls
              const collidedShapes = obstacles.map(ol => ol.getIntersection({ x: newX, y: newY })).filter(x => x)
              if (collidedShapes.length) {
                result.collision = 1
                result.reverse = 1
              }

              const changeColor = shape => {
                console.log(shape)
                if (shape.attrs.fill === 'green') {
                  shape.attrs.fill = 'yellow'
                } else if (shape.attrs.fill === 'yellow') {
                  shape.attrs.fill = 'red'
                } else if (shape.attrs.fill === 'red') {
                  shape.destroy()
                  c.o.destroy()
                }
              }

              // damage
              collidedShapes.map(changeColor)

              // TODO: don't forget to refactor this shit
              if (result.reverse) {
                if (move.direction === 'down') {
                  newY = newY - step * 2
                } else if (move.direction === 'downright') {
                  newX = newX - step * 2
                  newY = newY - step * 2
                } else if (move.direction === 'up') {
                  newY = newY + step * 2
                } else if (move.direction === 'downleft') {
                  newX = newX + step * 2
                  newY = newY - step * 2
                } else if (move.direction === 'right') {
                  newX = newX - step * 2
                } else if (move.direction === 'left') {
                  newX = newX + step * 2
                } else if (move.direction === 'upright') {
                  newX = newX - step * 2
                  newY = newY + step * 2
                } else if (move.direction === 'upleft') {
                  newX = newX + step * 2
                  newY = newY + step * 2
                }
              }

              return result
            }
            
            const colRes = collision(newX, newY)

            if (!colRes.collision || (colRes.collision && colRes.reverse)) {
              c.o.position({ x: newX, y: newY })
            }
          }
        }

        
        setInterval(move, 100, circles, moves)
      }

      

    </script>
</body>

<script>
      // ---------------- JUNK ------------------
      /*

        box.on('mouseover', function () {
          document.body.style.cursor = 'pointer'
        })

       
      */
</script>
