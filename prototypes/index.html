<style>
  body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #f0f0f0;
  }
</style>

<script src="https://unpkg.com/konva@8.3.0/konva.min.js"></script>

<body>
    <div id="canvas-container"></div>
    <script>
      /*
        TODO:
        user structures
        vison
        hp
      */

      const width = window.innerWidth
      const height = window.innerHeight

      const stage = new Konva.Stage({
        container: 'canvas-container',
        width: width,
        height: height,
      })

      console.log(stage)

      let layer = new Konva.Layer()
  
      const line = new Konva.Line({
        points: [0, 1100, width, 1100],
        stroke: 'black',
        strokeWidth: 3,
      })

      layer.add(line)
      stage.add(layer)

      const wall = new Konva.Rect({
        x: 50,
        y: 1130,
        width: 20,
        height: 100,
        fill: 'green',
        stroke: 'black',
        strokeWidth: 1,
        draggable: true
      })

      // wall.on('mouseout', _ => {
      //   document.body.style.cursor = 'default'
      // })

      const wallLayer = new Konva.Layer()

      wallLayer.add(wall)
      stage.add(wallLayer)

      const obstacles = []

      function runGame() {
        function createCircles(n) {
          const circles = []
          
          for (let i = 0; i < n; i++) {
            let circle = new Konva.Circle({
              x: 20,
              y: 500,
              radius: 10,
              fill: 'blue', // TODO
              strokeWidth: 0,
            })

            layer.add(circle)
            stage.add(layer)

            circles.push({ i, o: circle })
          }

          return circles
        }

        const circles = createCircles(8)

        const moves = [ // Testing
          { i: 0, direction: 'down' },
          { i: 1, direction: 'up' },
          { i: 2, direction: 'left' },
          { i: 3, direction: 'right' },
          { i: 4, direction: 'downleft' },
          { i: 5, direction: 'downright' },
          { i: 6, direction: 'upleft' },
          { i: 7, direction: 'upright' },
        ]

        function move(circles, moves) {
          for (const move of moves) {
            const step = 3

            const c = circles.find(x => x.i === move.i)
          
            let newX = c.o.attrs.x
            let newY = c.o.attrs.y

            if (move.direction === 'down') {
              newY = newY + step
            } else if (move.direction === 'downright') {
              newX = newX + step
              newY = newY + step
            } else if (move.direction === 'up') {
              newY = newY - step
            } else if (move.direction === 'downleft') {
              newX = newX - step
              newY = newY + step
            } else if (move.direction === 'right') {
              newX = newX + step
            } else if (move.direction === 'left') {
              newX = newX - step
            } else if (move.direction === 'upright') {
              newX = newX + step
              newY = newY - step
            } else if (move.direction === 'upleft') {
              newX = newX - step
              newY = newY - step
            }

            const collision = (x, y) => {
              // edges
              if (x <= 0 || y <= 0 || y >= 1100 || x >= window.innerWidth) return 1

              // walls
              if (wallLayer.getIntersection({ x: newX, y: newY })) return 1
            }
            
            if (!collision(newX, newY)) {
              c.o.position({ x: newX, y: newY })
            }
          }
        }

        
        setInterval(move, 1000, circles, moves)
      }

      // TODO: user code here

      runGame()

    </script>
</body>

<script>
      // ---------------- JUNK ------------------
      /*

        box.on('mouseover', function () {
          document.body.style.cursor = 'pointer'
        })

       
      */
</script>
